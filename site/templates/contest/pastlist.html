{% extends "common-content.html" %}
{% block meta %}
    <meta name="description" content="The {{ SITE_NAME }}'s contest list - past, present, and future.">
{% endblock %}

{% block js_media %}
    <style>
        .content-body-box {
            background-color: #f9fafb;
            font-family: "Pretendard";
            width: 100%;
        }
        #content-body {
            display: flex;
            flex-direction: row;
            gap: 20px;
        }
        .contest-group-container {
            width: 200px;
            display: flex;
            flex-direction: row;
            padding: 0;
            margin: 0;
            color: #8391A1;
            list-style-type: none;
            border-radius: 10px;
            visibility: hidden;
        }
        .contest-group-list {
            width: 100%;
        }
        .contest-group-item {
            height: 40px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            font-size: 16px;
            font-weight: 400;
            padding-left: 10px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        .contest-group-item:hover {
            background-color: #D9D9D936;
            transition: background-color 0.3s ease;
        }
        .contest-group-item input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        label .material-symbols-outlined {
            display: inline-block;
            border-radius: 50%;
            vertical-align: middle;
            padding: 0;
            box-sizing: border-box;
            margin-right: 10px;
            font-size: 24px;
            color: #D9D9D9;
        }
        .contest-group-item input[type="checkbox"]:checked + label .material-symbols-outlined {
            font-size: 24px;
            border: none;
            background: #FFFFFF;
            color: var(--LITMUS-primary, #5C95D9);
            border-radius: 50%;
        }
        .contest-group-item input[type="checkbox"]:checked + label .fa-regular.fa-circle::before {
            content: "\f058";
            font-weight: 900;
        }
        .contest-group-item label {
            cursor: pointer;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .contest-group-item.active {
            background: none;
            background-color: #D9D9D936;
            color: #373D47;
        }
        .contest-group-item.active label {
            color: #373D47;
        }
        .contest-head-block {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
        }
        .contest-contents {
            display: flex;
            flex-direction: column;
        }
        .contest-list-title {
            font-size: 18px;
            font-weight: 600;
        }
        .contest-time {
            display: flex;
            color: var(--font-grey);
            margin-left: 4px;
            padding-top: 0.5em;
        }
        .text-align {
            padding-top: 2px;
            font-size: 18px;
            color: var(--font-basic-black);
        }

        .text-align a {
            color: var(--font-basic-black);
            text-decoration: none; 
            transition: color 0.3s ease;
        }

        .text-align a:hover {
            color: var(--primary-color);
        }
        .contest-div {
            background: none;
            background-color: white;
            border-radius: 10px;
            padding: 18px 24px 12px 24px;
            margin: 0 0 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .content-description h4 {
            border-bottom: none;
            margin: 0;
            padding: 0 0 0 0;
            font-family: "Pretendard";
            font-size: 18px;
            font-weight: 500;
            line-height: 24px;
            text-align: left;
            color: var(--font-basic-black);
        }
        .table td {
            border-top: 1px solid rgba(217, 217, 217, 0.5);;        
            border-right: none;    
            border-left: none;      
            border-bottom: none; 
        }
        .table tr:first-child td {
            border: none; 
        }
        .table {
            border-spacing: 0;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 0.5em;
            background: rgba(255,255,255,1.0);
        }
        .contest-list td:last-child {
            width: 200px;
        }
        .table.striped tr:nth-child(even) {
            background: #ffffff;
        }
        .active {
            background: linear-gradient(90deg, rgba(159, 205, 242, 0.2) 0.62%, rgba(167, 231, 244, 0) 100.62%);
        }
        .contest-list tbody tr {
            height: 100px;
          }
        .event-bar {
            width: 8px;
            height: 42px;
            
            margin-right: 8px;
        }
        .contest-block{
            display: flex;
            font-family: "Pretendard";
            padding: 0.5em 0.5em 0.5em 1em;
        }
        .activity{
            background: linear-gradient(180deg, #9fcdf2 0%, #a7e7f4 100%);
        }
        .upcoming{
            background: linear-gradient(360deg, #FFD9A0 0%, #9FCDF2 100%);
        }
        .past{
            background: linear-gradient(360deg, #123B63 0%, #9FCDF2 100%);

        }
        .button, button, input[type=submit] {
            color: white ;
            text-decoration: none !important;
            cursor: pointer;
            vertical-align: middle;
            white-space: nowrap;
            font-weight: 500;
            background: var(--LITMUS-Primary, #5C95D9);
            border-radius: 10px;
            padding: 6px 12px;
            display: block;
            border: none;
            text-align: center;
            font-size: 14px;
            font-family: Pretendard;
            line-height: 17.5px;
            
        }
        form.contest-join-pseudotab input {
            display: inline;
            border: none;
            padding: 0;
            background: none;
            font-weight: 600;
            background: var(--LITMUS-Primary, #5C95D9);
        }
        form.contest-join-pseudotab {
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }
        .button:hover, button:hover, input[type=submit]:hover {
            background: var(--primary-hover-color);
        }
        .button:active, button:active, input[type=submit]:active {
            border-color: var(--white-hover-color);
            background: var(--primary-hover-color);
        }
        .button.full, button.full, input[type=submit].full {
            padding: 6px 0;
        }
        .button.disabled, button.disabled, input[type=submit].disabled {
            background: linear-gradient(to bottom, darkgray 0, gray 100%) repeat-x !important;
            border-color: grey !important;
            cursor: not-allowed;
        }
        .top-pagination-bar {
            margin: 0;
            margin-bottom: 1.5em;
            margin-left: auto;
            justify-content: right;
        }
        .top-pagination-bar .select2 {
            display: flex;
            flex-direction: row;
            justify-content: right;
        }
        .top-pagination-bar .select2-selection {
            width: 200px;
            height: 33px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding-left: 12px;
            font-size: 12px;
            color: black;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .top-pagination-bar .select2-selection__rendered {
            color: #8391A1;
            font-size: 12px;
        }

        .select2-search--dropdown .select2-search__field {
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        .select2-search--dropdown {
            left: 1040px;
        }
        .select2-dropdown {
            width: 200px !important;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        .bottom-pagination-bar {
            margin: 0 auto;
            margin-bottom: 21px;
            margin-top: 21px;
            display: flex;
            flex-direction: row;
            justify-content: center;
        }
        .bottom-pagination-bar .pagination {
            color: #8391A1;
        }
        ul.pagination > li.disabled-page {
            display: none;
        }   
        ul.pagination > li > a, ul.pagination > li > span {
            margin: 0 3px;
            background: none;
            border: none;
            color: #8391A1;
            border-radius: 20px !important;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        ul.pagination > .active-page > a, ul.pagination > .active-page > span {
            margin: 0 3px;
            background: none;
            color: #5C95D9;
            border-radius: 20px !important;
            transition: background-color 0.3s, box-shadow 0.3s;
            background-color: #f2f3f4;
        }
        ul.pagination > li > a:hover {
            background-color: #f2f3f4;
        }
    </style>
    <script src="{{ static('libs/featherlight/featherlight.min.js') }}" type="text/javascript"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $('.time-remaining').each(function () {
                count_down($(this));
            });

            $('.contest-tag').find('a[data-featherlight]').featherlight();

            $('.join-warning').click(function () {
                return confirm('{{ _('Are you sure you want to join?') }}\n' +
                    '{{ _('Joining a contest for the first time starts your timer, after which it becomes unstoppable.') }}');
            });
        });

        document.addEventListener("DOMContentLoaded", function() {
            const groupContainer = document.querySelector('.contest-group-container');
            if (groupContainer) {
                groupContainer.style.visibility = 'visible';
            }

            if (document.getElementById("all_subjects")) {
                document.getElementById("all_subjects").addEventListener('change', function() {
                    if (this.checked) {
                        document.querySelectorAll('input[name="subject_id"]').forEach(function(checkbox) {
                            checkbox.checked = false;
                            checkbox.closest('.contest-group-item').classList.remove('active');
                        });
                        this.closest('.contest-group-item').classList.add('active');
                        // Reset to initial URL by removing all subject_id parameters
                        const url = new URL(window.location.href);
                        url.searchParams.delete('subject_id');
                        window.location.href = url.toString();
                    }
                });
            }
            document.querySelectorAll('input[name="subject_id"]').forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        document.getElementById("all_subjects").checked = false;
                        document.getElementById("all_subjects").closest('.contest-group-item').classList.remove('active');
                        this.closest('.contest-group-item').classList.add('active');
                    } else {
                        this.closest('.contest-group-item').classList.remove('active');
                    }
                    applyFilter();
                });
            });

            const urlParams = new URLSearchParams(window.location.search);
            const selectedSubjects = urlParams.getAll('subject_id');

            if (selectedSubjects.length > 0) {
                if (document.getElementById("all_subjects")) {
                    document.getElementById("all_subjects").checked = false;
                    document.getElementById("all_subjects").closest('.contest-group-item').classList.remove('active');
                }
            } else {
                if (document.getElementById("all_subjects")) {
                    document.getElementById("all_subjects").checked = true;
                    document.getElementById("all_subjects").closest('.contest-group-item').classList.add('active');
                }
            }
            selectedSubjects.forEach(function(subjectId) {
                const checkbox = document.querySelector(`input[name="subject_id"][value="${subjectId}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    checkbox.closest('.contest-group-item').classList.add('active');
                }
            });
        });

        function applyFilter() {
            const selectedSubjects = [];
            document.querySelectorAll('input[name="subject_id"]:checked').forEach(function(checkbox) {
                if (checkbox.value) {
                    selectedSubjects.push(checkbox.value);
                }
            });

            const url = new URL(window.location.href);
            url.searchParams.delete('subject_id');
            selectedSubjects.forEach(function(subjectId) {
                url.searchParams.append('subject_id', subjectId);
            });
            window.location.href = url.toString();
        }
    </script>
{% endblock %}

{% block title_ruler %}{% endblock %}

{% block title_row %}
    {% set tab = 'pastlist' %}
    {% include "contest/contest-list-tabs.html" %}
{% endblock %}

{% macro contest_head(contest) %}
    {% spaceless %}
        <a href="{{ url('contest_view', contest.key) }}" class="contest-list-title">
            {{- contest.name -}}
        </a>
        
    {% endspaceless %}
{% endmacro %}

{% macro time_left(contest) %}
    <div class="time time-left">
        {% if contest.time_limit %}
            {{ contest.start_time|date(_("M j, Y, G:i")) }} KST ~
            {{ contest.end_time|date(_("M j, Y, G:i")) }} KST
        {% else %}
            {{ contest.start_time|date(_("M j, Y, G:i")) }} KST ~
            {{ contest.end_time|date(_("M j, Y, G:i")) }} KST
        {% endif %}
        <br>
        {% if contest.time_limit %}
            
        {% else %}
            
        {% endif %}
    </div>
{% endmacro %}

{% macro user_count(contest, user) %}
    {% if contest.can_see_own_scoreboard(user) %}
        <a href="{{ url('contest_ranking', contest.key) }}">{{ contest.user_count }}</a>
    {% else %}
        {{ contest.user_count }}
    {% endif %}
{% endmacro %}

{% macro contest_join(contest, request, finished_contests) %}
    {% if not request.in_contest %}
        <td>
            {% if contest.is_live_joinable_by(request.user) %}
                <form action="{{ url('contest_join', contest.key) }}" method="post">
                    {% csrf_token %}
                    <input type="submit" class="unselectable button full participate-button join-warning"
                           value="{{ _('Join') }}">
                </form>
            {% elif contest.is_spectatable_by(request.user) %}
                <form action="{{ url('contest_join', contest.key) }}" method="post">
                    {% csrf_token %}
                    <input type="submit" class="unselectable button full participate-button"
                           value="{{ _('Spectate') }}">
                </form>
            {% else %}
                <form action="{{ url('contest_join', contest.key) }}" method="post">
                    {% csrf_token %}
                    <input type="submit" class="unselectable button full participate-button disabled"
                           value="{{ _('Join') }}" disabled title="{{ _('You cannot join this contest.') }}">
                </form>
            {% endif %}
        </td>
    {% endif %}
{% endmacro %}



{% block body %}
    {% if is_practice %}
        <div class="contest-group-container">
            <div class="contest-group-list">
                <li class="contest-group-item {% if not request.GET.subject_id %}active{% endif %}">
                    <input type="checkbox" id="all_subjects" name="subjects" value="" >
                    <label for="all_subjects">
                        <i class="fa-regular fa-circle material-symbols-outlined"></i>
                        모든 과목
                    </label>
                </li>
                {% for subject in subjects %}
                    <li class="contest-group-item {% if request.GET.subject_id and subject.id|string in request.GET.subject_id %}active{% endif %}">
                        <input type="checkbox" id="subject_{{ subject.id }}" name="subject_id" value="{{ subject.id }}" >
                        <label for="subject_{{ subject.id }}">
                            <i class="fa-regular fa-circle material-symbols-outlined"></i>
                             {{  subject.name }}
                        </label>
                    </li>
                {% endfor %}
            </div>
        </div>
    {% endif %}
    {% if is_practice %}
        <style>
            .content-description {
                width: 78%;
            }
        </style>
    {% else %}
        <style>
            .content-description {
                width: 100%;
            }
        </style>
    {% endif %}
    <div class="content-description">
        <!-- this is made myself-->
        {% if past_own_contests.object_list %}
            <div class="contest-div">
                <!-- <h4>{{ _('Active contests') }}</h4> -->
                {% if request.path == '/contests/1/past' %}
                    <h4>개설한 종료된 과제</h4>
                {% else %}
                    <h4>개설한 종료된 대회</h4>
                {% endif %}
                <table class="contest-list table striped">
                    <tbody>
                    <!-- currently, here shows problems that can be spectated -->
                    {% for contest in past_own_contests.object_list %}
                    <tr>
                        <td>
                            <div class="contest-block">
                                <!-- <div class="past event-bar"></div> --> 
                                
                                <div class="contest-contents">
                                    <div class="contest-head-block">
                                        {% if request.path == '/contests/1/past' %}
                                            <span class="material-symbols-outlined md-end-grad md-24">book_2</span>
                                        {% else %}
                                            <span class="material-symbols-outlined md-end-grad md-24">trophy</span>
                                        {% endif %}
                                        <div class="text-align">
                                            {{ contest_head(contest) }}
                                        </div>
                                    </div>

                                    <div class="contest-time">
                                        {% if contest.start_time %}
                                            <br>
                                            {% if contest.time_before_end %}
                                                
                                            {% endif %}
                                            {{ time_left(contest) }}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
                {% if past_own_contests.has_other_pages() %}
                    <div class="bottom-pagination-bar">
                        <ul class="pagination">
                            <!-- 이전 페이지 버튼 -->
                            {% if past_own_contests.has_previous() %}
                                <li>
                                    <a href="?own_page={{ past_own_contests.previous_page_number() }}&other_page={{ past_other_contests.number }}" class="page-arrow"><i class="fa-solid fa-chevron-left"></i></a>
                                </li>
                            {% else %}
                                <li class="disabled-page"><i class="fa-solid fa-chevron-left"></i></li>
                            {% endif %}

                            <!-- 페이지 범위 -->
                            {% for page in past_own_contests.paginator.page_range %}
                                {% if not page %}
                                    <li class="disabled-page"><span>...</span></li>
                                {% else %}
                                    {% if page == past_own_contests.number %}
                                        <li class="active-page"><a>{{ page }}</a></li>
                                    {% else %}
                                        <li>
                                            <a href="?own_page={{ page }}&other_page={{ past_other_contests.number }}">{{ page }}</a>
                                        </li>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            <!-- 다음 페이지 버튼 -->
                            {% if past_own_contests.has_next() %}
                                <li>
                                    <a href="?own_page={{ past_own_contests.next_page_number() }}&other_page={{ past_other_contests.number }}" class="page-arrow"><i class="fa-solid fa-chevron-right"></i></a>
                                </li>
                            {% else %}
                                <li class="disabled-page"><span class="page-arrow"><i class="fa-solid fa-chevron-right"></i></span></li>
                            {% endif %}
                        </ul>
                    </div>
                {% endif %}

            </div>
        {% endif %}

        {% if past_other_contests %}
            <div class="contest-div">
                {% if is_practice %}
                    <h4 id="past-assignments">종료된 과제</h4>
                {% else %}
                    <h4 id="past-contests">종료된 대회</h4>
                {% endif %}
                <table class="contest-list table striped">
                    <tbody>
                    {% for contest in past_other_contests %}
                        <tr>
                            <td>
                                <div class="contest-block">
                                    <!-- <div class="past event-bar"></div> -->
                                    <div class="contest-contents">
                                        <div class="contest-head-block">
                                            {% if is_practice %}
                                                <span class="material-symbols-outlined md-end-grad md-24">book_2</span>
                                            {% else %}
                                                <span class="material-symbols-outlined md-end-grad md-24">trophy</span>
                                            {% endif %}
                                            <div class="text-align">
                                                {{ contest_head(contest) }}
                                            </div>
                                        </div>

                                        <div class="contest-time">
                                            {{ time_left(contest) }}
                                        </div>
                                </div>
                            </td>
                            <td>
                                {# <!-- {% if request.user.is_authenticated %}
                                    {% set cur_contest = request.user.profile.current_contest %}
                                    <!-- 현재 대회가 없거나 현재 대회와 다른 대회인 경우에만 모의 참여 버튼 생성-->
                                    {% if not cur_contest or cur_contest.contest != contest %}
                                        <form action="{{ url('contest_join', contest.key) }}" method="post">
                                                {% csrf_token %}
                                                <input type="submit" class="unselectable button full participate-button"
                                                    value="{{ _('Virtual join') }}">
                                        </form>
                                    {% else %}
                                        <form action="{{ url('contest_view', contest.key) }}" method="post">
                                            {% csrf_token %}
                                            <input type="submit" class="unselectable button full participate-button"
                                                value="{{ _('참여 중') }}">
                                        </form>
                                    {% endif %}
                                {% endif %} --> #}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                
                {% if past_other_contests.has_other_pages() %}
                    <div class="bottom-pagination-bar">
                        <ul class="pagination">
                            {% if past_other_contests.has_previous() %}
                                <li>
                                    <a href="?own_page={{ past_own_contests.number }}&other_page={{ past_other_contests.previous_page_number() }}" class="page-arrow"><i class="fa-solid fa-chevron-left"></i></a>
                                </li>
                            {% else %}
                                <li class="disabled-page"><i class="fa-solid fa-chevron-left"></i></li>
                            {% endif %}
                
                            {% for page in past_other_contests.paginator.page_range %}
                                {% if page is none %}
                                    <li class="disabled-page"><span>...</span></li>
                                {% elif page == past_other_contests.number %}
                                    <li class="active-page"><a>{{ page }}</a></li>
                                {% else %}
                                    <li>
                                        <a href="?own_page={{ past_own_contests.number }}&other_page={{ page }}">{{ page }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                
                            {% if past_other_contests.number < past_other_contests.paginator.num_pages %}
                                <li>
                                    <a href="?own_page={{ past_own_contests.number }}&other_page={{ past_other_contests.next_page_number() }}" class="page-arrow"><i class="fa-solid fa-chevron-right"></i></a>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                {% endif %}
            

            </div>
        {% endif %}
    </div>
{% endblock %}
